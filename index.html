<!DOCTYPE html>
<html lang="zh-es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å›½å¹´ V21 - ä¸­è¥¿åŒè¯­ç§‘å­¦ç‰ˆ (äº‘ç«¯åŒæ­¥)</title>
    <style>
        :root { --main-red: #c62828; --gold: #fbc02d; --blue: #1565c0; --green: #2e7d32; --bg: #fdf2f2; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: #333; }
        header { background: var(--main-red); color: var(--gold); padding: 15px; text-align: center; border-bottom: 5px solid var(--gold); }
        .container { padding: 15px; max-width: 1300px; margin: auto; }
        
        .dash-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .dash-card { background: white; padding: 12px; border-radius: 10px; border-left: 5px solid var(--main-red); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .dash-card h4 { margin: 0; color: #666; font-size: 13px; }
        .dash-card .val { font-size: 20px; font-weight: bold; color: var(--main-red); margin-top: 5px; }

        .nav-bar { background: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .admin-only { display: none !important; }
        .admin-mode .admin-only { display: block !important; }

        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .cat-bar { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid #eee; }
        .cat-btn { padding: 6px 15px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; white-space: nowrap; }
        .cat-btn.active { background: var(--main-red); color: white; border-color: var(--main-red); }

        .bill-zone { background: #fffde7; border: 2px dashed var(--gold); padding: 15px; border-radius: 8px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f8f8; color: var(--main-red); font-size: 13px; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-red { background: var(--main-red); color: white; }
        .btn-gold { background: var(--gold); color: #333; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; }
        
        .fridge-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .fridge-card { background: white; border: 2px solid #ddd; border-radius: 10px; padding: 12px; text-align: center; cursor: pointer; }
        .fridge-card.active { border-color: var(--main-red); background: #fff8f8; }

        .stat-line { background: #e8f5e9; padding: 15px; margin-top: 10px; border-radius: 8px; font-weight: bold; display: flex; justify-content: space-between; font-size: 16px; border: 1px solid #c5e1a5; }

        .filter-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; }

        #cloud-status { 
            background: #e8f5e9; 
            padding: 5px 10px; 
            border-radius: 20px; 
            font-size: 12px; 
            display: inline-block;
            margin-left: 10px;
        }

        @media print {
            .no-print, header, .nav-bar, .fridge-grid, #transferBox, .input-area, .admin-only, .dash-board, .cat-bar, .filter-bar, #cloud-status { display: none !important; }
            .print-full-report { display: block !important; }
            table { font-size: 11px; border: 1px solid #000; }
            th, td { border: 1px solid #000; padding: 5px; }
            .print-area-title { background: #eee; padding: 8px; margin-top: 20px; font-weight: bold; border: 1px solid #000; }
        }
        .print-full-report { display: none; }
    </style>
</head>
<body>

<header class="no-print">
    <h1>ä¸­å›½å¹´ç®¡ç†ç³»ç»Ÿ / GestiÃ³n China</h1>
    <p>åŒè¯­ç§‘å­¦ç‰ˆ V21 (Dual Lenguaje) - äº‘ç«¯åŒæ­¥</p>
</header>

<div class="container">
    <div class="dash-board no-print">
        <div class="dash-card">
            <h4>ä»Šæ—¥é”€å”®é¢ / Venta Hoy</h4>
            <div class="val" id="dashTodayVenta">C$ 0.00</div>
        </div>
        <div class="dash-card" style="border-left-color: var(--blue);">
            <h4>ä»Šæ—¥è¿›è´§é¢ / Compra Hoy</h4>
            <div class="val" id="dashTodayBuy">C$ 0.00</div>
        </div>
        <div class="dash-card" style="border-left-color: #fb8c00;">
            <h4>æ€»åº“å­˜è´§å€¼ / Valor Total</h4>
            <div class="val" id="dashStockValue">C$ 0.00</div>
        </div>
    </div>

    <div class="nav-bar no-print">
        <div style="display:flex; align-items:center; gap:10px;">
            <span id="roleText" style="font-weight:bold;">ğŸ‘¤ æƒé™: å‘˜å·¥ / Empleado</span>
            <span id="cloud-status" style="background:#e8f5e9; padding:5px 10px; border-radius:20px; font-size:12px;">â˜ï¸ äº‘ç«¯: è¿æ¥ä¸­...</span>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-gold" onclick="handleAuth()">æƒé™ç™»å½• / Login</button>
            <button class="btn btn-blue" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°å…¨è¡¨ / Imprimir</button>
        </div>
    </div>

    <div class="card admin-only no-print">
        <h3>ğŸ› ï¸ æ¡£æ¡ˆä¸åˆ†ç±» / Maestro y CategorÃ­as</h3>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(100px, 1fr)); gap:5px; margin-bottom:15px;">
            <input type="text" id="mCat" placeholder="åˆ†ç±»/Cat">
            <input type="text" id="mName" placeholder="åç§°/Nombre">
            <input type="text" id="mSpec" placeholder="è§„æ ¼/Spec">
            <input type="number" id="mCost" placeholder="æˆæœ¬/Costo">
            <input type="number" id="mPrice" placeholder="å”®ä»·/Precio">
            <button class="btn btn-red" onclick="saveMaster()">ä¿å­˜ / Guardar</button>
        </div>
        <hr>
        <h3>ğŸ§¾ è¿›è´§å•æ®å½•å…¥ / Registro de Factura</h3>
        <div class="bill-zone">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <select id="mSelect" style="flex:2; padding:8px;"></select>
                <input type="number" id="inQty" placeholder="æ•°/Cant" style="width:80px;" min="1">
                <button class="btn btn-red" onclick="addItemToTempBill()">æ·»åŠ /AÃ±adir</button>
            </div>
            <table id="tempBillTable">
                <thead><tr><th>å“å/Prod</th><th>æ•°é‡/Cant</th><th>å°è®¡/Sub</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="tempBillBody"></tbody>
            </table>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                <h4 id="tempBillTotal">æ€»é¢/Total: C$ 0.00</h4>
                <button class="btn btn-gold" onclick="submitFinalBill()">æ•´å•å…¥åº“ / Guardar Todo</button>
            </div>
        </div>
    </div>

    <div class="fridge-grid no-print">
        <div class="fridge-card" id="btn-wh" onclick="selectArea('æ€»ä»“åº“')">ğŸ“¦ æ€»ä»“åº“/AlmacÃ©n</div>
        <div class="fridge-card" id="btn-n1" onclick="selectArea('1å·å†°ç®±')">â„ï¸ 1å·/Nevera 1</div>
        <div class="fridge-card" id="btn-n2" onclick="selectArea('2å·å†°ç®±')">â„ï¸ 2å·/Nevera 2</div>
        <div class="fridge-card" id="btn-n3" onclick="selectArea('3å·å†°ç®±')">â„ï¸ 3å·/Nevera 3</div>
    </div>

    <div id="catNav" class="cat-bar no-print"></div>

    <div id="transferBox" class="card no-print" style="display:none; background:#e3f2fd; border:1px solid #bbdefb;">
        <strong>å¿«é€Ÿè°ƒæ‹¨ / Traslado: </strong>
        <select id="moveS"></select> â†’ 
        <select id="moveT">
            <option value="1å·å†°ç®±">1å·/N1</option><option value="2å·å†°ç®±">2å·/N2</option><option value="3å·å†°ç®±">3å·/N3</option>
        </select>
        <input type="number" id="moveQ" placeholder="æ•°/Cant" style="width:60px" min="1">
        <button class="btn btn-blue" onclick="execMove()">æ‰§è¡Œ / Ejecutar</button>
    </div>

    <div class="card no-print">
        <h3 id="areaTitle">è¯·é€‰æ‹©åŒºåŸŸ / Seleccione Ãrea</h3>
        <table id="stockTable">
            <thead>
                <tr><th>åˆ†ç±»/Cat</th><th>å“å/Producto</th><th>å”®ä»·/Precio</th><th>åº“å­˜/Stock</th><th class="input-area">ç›˜ç‚¹/Venta</th></tr>
            </thead>
            <tbody id="stockBody"></tbody>
        </table>
        <div id="areaSummaryLine" class="stat-line" style="display:none;">
            <span>åŒºåŸŸè´§å€¼ / Valor Area:</span>
            <span id="areaSummaryMoney">C$ 0.00</span>
        </div>
    </div>

    <div class="card no-print">
        <h3>ğŸ“Š å†å²å¯¹è´¦æ£€ç´¢ / Historial y BÃºsqueda</h3>
        <div class="filter-bar">
            <input type="month" id="filterMonth" onchange="render()">
            <input type="date" id="filterStart" onchange="render()">
            <input type="date" id="filterEnd" onchange="render()">
            <input type="text" id="filterSearch" placeholder="æœç´¢å“å... / Buscar" oninput="render()">
        </div>
        <table>
            <thead><tr><th>æ—¶é—´/Fecha</th><th>æ‘˜è¦/Nota</th><th>å˜åŠ¨/Cant</th><th>é‡‘é¢/Monto</th><th class="admin-only">X</th></tr></thead>
            <tbody id="logBody"></tbody>
            <tfoot id="logFoot"></tfoot>
        </table>
    </div>

    <div class="print-full-report">
        <h2 style="text-align:center;">å…¨åŸŸåº“å­˜ç›˜ç‚¹æ¸…å• / Inventario Global</h2>
        <div id="printContainer"></div>
    </div>
</div>

<script>
    // ==================== Firebase é…ç½®ï¼ˆä½¿ç”¨ä½ ç°æœ‰çš„é¡¹ç›®ï¼‰====================
    const firebaseConfig = {
        apiKey: "AIzaSyC3ADmd485_ITMpwaLbLDtctrROiwLHbHw",
        authDomain: "restaurant-cw.firebaseapp.com",
        databaseURL: "https://restaurant-cw-default-rtdb.firebaseio.com",
        projectId: "restaurant-cw",
        storageBucket: "restaurant-cw.firebasestorage.app",
        messagingSenderId: "980204506513",
        appId: "1:980204506513:web:ae195605300782435d9e30",
        measurementId: "G-43206TF3VJ"
    };

    // ==================== å…¨å±€å˜é‡ ====================
    const STORAGE_KEY = "cn_master_v21";
    const ADMIN_PASS = "8888";
    let isAdmin = false, activeArea = "", activeCat = "å…¨éƒ¨/Todo", tempBillItems = [];
    let firebaseApp = null, firestore = null, firebaseLoaded = false, syncInProgress = false, autoSyncInterval = null;
    
    // åˆå§‹åŒ–æ•°æ®
    let master = JSON.parse(localStorage.getItem('cn_m21')) || [];
    let stocks = JSON.parse(localStorage.getItem('cn_s21')) || [];
    let logs = JSON.parse(localStorage.getItem('cn_l21')) || [];

    // ç¡®ä¿æ¯ä¸ªåº“å­˜é¡¹éƒ½æœ‰å¿…è¦å­—æ®µ
    stocks = stocks.map(s => ({
        id: s.id || Date.now(),
        cat: s.cat || "æœªåˆ†ç±»",
        name: s.name || "æœªçŸ¥",
        spec: s.spec || "",
        qty: s.qty || 0,
        cost: s.cost || 0,
        price: s.price || 0,
        location: s.location || "æ€»ä»“åº“"
    }));

    // ==================== Firebase åˆå§‹åŒ– ====================
    async function initFirebase() {
        try {
            document.getElementById('cloud-status').innerHTML = 'â˜ï¸ äº‘ç«¯: åŠ è½½ä¸­...';
            
            await loadFirebaseSDK();
            
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app();
            }
            
            firestore = firebase.firestore();
            await firebase.auth().signInAnonymously();
            
            firebaseLoaded = true;
            document.getElementById('cloud-status').innerHTML = 'â˜ï¸ äº‘ç«¯: âœ… å·²è¿æ¥';
            
            await loadFromCloud();
            
        } catch (error) {
            console.error('Firebase åˆå§‹åŒ–å¤±è´¥:', error);
            document.getElementById('cloud-status').innerHTML = 'â˜ï¸ äº‘ç«¯: âŒ è¿æ¥å¤±è´¥';
        }
    }

    function loadFirebaseSDK() {
        return new Promise((resolve, reject) => {
            if (window.firebase) {
                resolve();
                return;
            }
            
            const script1 = document.createElement('script');
            script1.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js';
            
            script1.onload = () => {
                const script2 = document.createElement('script');
                script2.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js';
                const script3 = document.createElement('script');
                script3.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js';
                
                Promise.all([
                    new Promise(r => { script2.onload = r; document.head.appendChild(script2); }),
                    new Promise(r => { script3.onload = r; document.head.appendChild(script3); })
                ]).then(resolve).catch(reject);
            };
            
            script1.onerror = reject;
            document.head.appendChild(script1);
        });
    }

    // ==================== äº‘ç«¯åŒæ­¥å‡½æ•° ====================
    async function saveToCloud() {
        if (!firebaseLoaded || !firestore || syncInProgress) return false;
        
        try {
            syncInProgress = true;
            await firestore.collection('inventoryData').doc('mainData').set({
                master: master,
                stocks: stocks,
                logs: logs,
                lastSync: new Date().toISOString()
            });
            document.getElementById('cloud-status').innerHTML = 'â˜ï¸ äº‘ç«¯: âœ… å·²åŒæ­¥ ' + new Date().toLocaleTimeString();
            return true;
        } catch (error) {
            console.error('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', error);
            document.getElementById('cloud-status').innerHTML = 'â˜ï¸ äº‘ç«¯: âš ï¸ åŒæ­¥å¤±è´¥';
            return false;
        } finally {
            syncInProgress = false;
        }
    }

    async function loadFromCloud() {
        if (!firebaseLoaded || !firestore) return false;
        
        try {
            const doc = await firestore.collection('inventoryData').doc('mainData').get();
            
            if (doc.exists) {
                const cloudData = doc.data();
                // ç§»é™¤ lastSync å­—æ®µï¼Œåªä¿ç•™æ•°æ®
                delete cloudData.lastSync;
                
                // æ¯”è¾ƒæœ¬åœ°å’Œäº‘ç«¯ï¼Œå–æ›´æ–°çš„é‚£ä¸ª
                const localData = localStorage.getItem(STORAGE_KEY);
                if (localData) {
                    const localParsed = JSON.parse(localData);
                    console.log("ä½¿ç”¨æœ¬åœ°æ•°æ®");
                    // å·²ç»æœ‰æœ¬åœ°æ•°æ®äº†ï¼Œä¸åšæ“ä½œ
                } else {
                    // æœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œç”¨äº‘ç«¯çš„
                    if (cloudData.master) master = cloudData.master;
                    if (cloudData.stocks) stocks = cloudData.stocks;
                    if (cloudData.logs) logs = cloudData.logs;
                    localStorage.setItem('cn_m21', JSON.stringify(master));
                    localStorage.setItem('cn_s21', JSON.stringify(stocks));
                    localStorage.setItem('cn_l21', JSON.stringify(logs));
                    document.getElementById('cloud-status').innerHTML = 'â˜ï¸ äº‘ç«¯: âœ… å·²åŠ è½½äº‘ç«¯æ•°æ®';
                }
                render();
                return true;
            } else {
                // äº‘ç«¯æ²¡æœ‰æ•°æ®ï¼Œä¸Šä¼ æœ¬åœ°
                await saveToCloud();
                return false;
            }
        } catch (error) {
            console.error('ä»äº‘ç«¯åŠ è½½å¤±è´¥:', error);
            return false;
        }
    }

    // ==================== åŸæœ‰åŠŸèƒ½å‡½æ•° ====================
    function save() {
        localStorage.setItem('cn_m21', JSON.stringify(master));
        localStorage.setItem('cn_s21', JSON.stringify(stocks));
        localStorage.setItem('cn_l21', JSON.stringify(logs));
        saveToCloud(); // åŒæ­¥åˆ°äº‘ç«¯
        render();
    }

    function handleAuth() {
        if(!isAdmin) { 
            const pwd = prompt("è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç  / ContraseÃ±a Admin:");
            if(pwd === ADMIN_PASS) {
                isAdmin = true; 
            } else {
                alert("å¯†ç é”™è¯¯ / ContraseÃ±a incorrecta");
                return;
            }
        } else {
            isAdmin = false;
        }
        updateAdminMode();
        render();
    }

    function updateAdminMode() {
        if (isAdmin) {
            document.body.classList.add('admin-mode');
            document.getElementById('roleText').innerHTML = "ğŸ‘¤ ç®¡ç†å‘˜ / Admin";
        } else {
            document.body.classList.remove('admin-mode');
            document.getElementById('roleText').innerHTML = "ğŸ‘¤ å‘˜å·¥ / Empleado";
        }
    }

    function saveMaster() {
        if (!isAdmin) {
            alert("åªæœ‰ç®¡ç†å‘˜å¯æ“ä½œ / Solo Admin");
            return;
        }
        const c = document.getElementById('mCat').value || "General", 
              n = document.getElementById('mName').value;
        const s = document.getElementById('mSpec').value, 
              ct = parseFloat(document.getElementById('mCost').value) || 0, 
              p = parseFloat(document.getElementById('mPrice').value) || 0;
        if(n) { 
            master.push({id:Date.now(), cat:c, name:n, spec:s, cost:ct, price:p}); 
            save(); 
            document.getElementById('mCat').value = '';
            document.getElementById('mName').value = '';
            document.getElementById('mSpec').value = '';
            document.getElementById('mCost').value = '';
            document.getElementById('mPrice').value = '';
        } else {
            alert("è¯·è¾“å…¥åç§° / Ingrese nombre");
        }
    }

    function addItemToTempBill() {
        const mid = document.getElementById('mSelect').value, 
              qty = parseInt(document.getElementById('inQty').value);
        if(!mid || !qty || qty <= 0) {
            alert("è¯·é€‰æ‹©å•†å“å¹¶è¾“å…¥æœ‰æ•ˆæ•°é‡ / Seleccione producto y cantidad vÃ¡lida");
            return;
        }
        const m = master.find(x => x.id == mid);
        if (!m) return;
        tempBillItems.push({ ...m, qty, sub: m.cost * qty });
        document.getElementById('inQty').value = '';
        renderTempBill();
    }

    function renderTempBill() {
        let total = 0;
        document.getElementById('tempBillBody').innerHTML = tempBillItems.map((item, idx) => {
            total += item.sub;
            return `<tr><td>${item.name} (${item.spec})</td><td>${item.qty}</td><td>C$ ${item.sub.toFixed(1)}</td><td><button class="btn-red" onclick="removeTempItem(${idx})">X</button></td></tr>`;
        }).join('');
        document.getElementById('tempBillTotal').innerText = `æ€»é¢/Total: C$ ${total.toFixed(2)}`;
    }

    function removeTempItem(idx) {
        tempBillItems.splice(idx, 1);
        renderTempBill();
    }

    function submitFinalBill() {
        if(!tempBillItems.length) {
            alert("è¯·å…ˆæ·»åŠ å•†å“ / AÃ±ada productos primero");
            return;
        }
        let total = 0;
        tempBillItems.forEach(item => {
            let s = stocks.find(x => x.name === item.name && x.location === 'æ€»ä»“åº“' && x.spec === item.spec);
            if(s) {
                s.qty += item.qty;
            } else {
                stocks.push({
                    id:Date.now(), 
                    cat:item.cat, 
                    name:item.name, 
                    spec:item.spec, 
                    qty:item.qty, 
                    cost:item.cost, 
                    price:item.price, 
                    location:'æ€»ä»“åº“'
                });
            }
            total += item.sub;
        });
        logs.push({
            id:Date.now(), 
            t:new Date().toISOString(), 
            type:'è¿›è´§/Compra', 
            note:`æ‰¹é‡å…¥åº“ ${tempBillItems.length}é¡¹`, 
            q:tempBillItems.length, 
            amt:total
        });
        tempBillItems = []; 
        renderTempBill(); 
        save();
    }

    function selectArea(area) {
        activeArea = area;
        document.querySelectorAll('.fridge-card').forEach(c => c.classList.remove('active'));
        const map = {'æ€»ä»“åº“':'btn-wh','1å·å†°ç®±':'btn-n1','2å·å†°ç®±':'btn-n2','3å·å†°ç®±':'btn-n3'};
        document.getElementById(map[area]).classList.add('active');
        document.getElementById('areaTitle').innerText = `${area}`;
        document.getElementById('transferBox').style.display = (area==='æ€»ä»“åº“'?'block':'none');
        render();
    }

    function execMove() {
        if (!isAdmin) {
            alert("åªæœ‰ç®¡ç†å‘˜å¯è°ƒæ‹¨ / Solo Admin");
            return;
        }
        const sid = document.getElementById('moveS').value, 
              target = document.getElementById('moveT').value, 
              qty = parseInt(document.getElementById('moveQ').value);
        if (!sid || !qty || qty <= 0) {
            alert("è¯·é€‰æ‹©å•†å“å’Œæ•°é‡ / Seleccione producto y cantidad");
            return;
        }
        const s = stocks.find(x => x.id == sid);
        if(s && qty <= s.qty) {
            s.qty -= qty;
            let ts = stocks.find(x => x.name === s.name && x.location === target && x.spec === s.spec);
            if(ts) {
                ts.qty += qty;
            } else {
                stocks.push({
                    ...s, 
                    id:Date.now(), 
                    qty: qty, 
                    location: target
                });
            }
            logs.push({
                id:Date.now(), 
                t:new Date().toISOString(), 
                type:'è°ƒæ‹¨/Traslado', 
                note:`ä»æ€»ä»“åº“åˆ° ${target}: ${s.name}`, 
                q:qty, 
                amt:0
            });
            document.getElementById('moveQ').value = '';
            save();
        } else {
            alert("åº“å­˜ä¸è¶³ / Stock insuficiente");
        }
    }

    function doCheck(id) {
        if (!isAdmin) {
            alert("åªæœ‰ç®¡ç†å‘˜å¯ç›˜ç‚¹ / Solo Admin");
            return;
        }
        const input = document.getElementById(`input-${id}`), 
              real = parseInt(input.value), 
              s = stocks.find(x => x.id === id);
        if(!s) return;
        
        if(isNaN(real) || real < 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆæ•°é‡ / Ingrese cantidad vÃ¡lida");
            return;
        }
        
        const gap = s.qty - real;
        if(gap < 0) {
            alert("å®ç›˜ä¸èƒ½å¤§äºç³»ç»Ÿåº“å­˜ / Real no puede > sistema");
            return;
        }
        
        if(gap > 0) {
            logs.push({
                id:Date.now(), 
                t:new Date().toISOString(), 
                type:'é”€å”®/Venta', 
                note:`${s.name} @ ${s.location}`, 
                q:gap, 
                amt:gap * s.price
            });
            s.qty = real;
        }
        input.value = ''; 
        save();
    }

    function render() {
        // æ›´æ–°æƒé™æ¨¡å¼æ˜¾ç¤º
        updateAdminMode();
        
        // ç”Ÿæˆåˆ†ç±»å¯¼èˆª
        const cats = ["å…¨éƒ¨/Todo", ...new Set(master.map(m => m.cat))];
        document.getElementById('catNav').innerHTML = cats.map(c => 
            `<button class="cat-btn ${activeCat===c?'active':''}" onclick="activeCat='${c}';render()">${c}</button>`
        ).join('');
        
        // æ›´æ–°å•†å“é€‰æ‹©ä¸‹æ‹‰æ¡†
        document.getElementById('mSelect').innerHTML = [...master]
            .sort((a,b)=> (a.cat || '').localeCompare(b.cat || ''))
            .map(m => `<option value="${m.id}">[${m.cat}] ${m.name} ${m.spec}</option>`).join('');
        
        // æ›´æ–°è°ƒæ‹¨ä¸‹æ‹‰æ¡†
        document.getElementById('moveS').innerHTML = stocks
            .filter(x => x.location === 'æ€»ä»“åº“')
            .map(s => `<option value="${s.id}">${s.name} ${s.spec} (${s.qty})</option>`).join('');

        // è®¡ç®—ä»ªè¡¨ç›˜æ•°æ®
        const today = new Date().toISOString().slice(0,10);
        let tVenta = 0, tBuy = 0, totalStockVal = 0, areaVal = 0;
        
        logs.forEach(l => { 
            if(l.t && l.t.startsWith(today)) { 
                if(l.type && l.type.includes('é”€å”®')) tVenta += l.amt || 0; 
                if(l.type && l.type.includes('è¿›è´§')) tBuy += l.amt || 0; 
            }
        });
        
        stocks.forEach(s => { 
            totalStockVal += (s.qty || 0) * (s.cost || 0);
            if(s.location === activeArea) areaVal += (s.qty || 0) * (s.cost || 0);
        });

        document.getElementById('dashTodayVenta').innerText = `C$ ${tVenta.toFixed(1)}`;
        document.getElementById('dashTodayBuy').innerText = `C$ ${tBuy.toFixed(1)}`;
        document.getElementById('dashStockValue').innerText = `C$ ${totalStockVal.toFixed(0)}`;

        // æ¸²æŸ“åº“å­˜è¡¨
        let displayStocks = stocks.filter(x => x.location === activeArea);
        if(activeCat !== "å…¨éƒ¨/Todo") displayStocks = displayStocks.filter(x => x.cat === activeCat);
        
        document.getElementById('stockBody').innerHTML = displayStocks.map(s => `
            <tr>
                <td><small>${s.cat || ''}</small></td>
                <td><b>${s.name || ''}</b> <small>${s.spec || ''}</small></td>
                <td>C$ ${(s.price || 0).toFixed(1)}</td>
                <td><b style="color:var(--main-red)">${s.qty || 0}</b></td>
                <td class="input-area ${!isAdmin ? 'admin-only' : ''}">
                    <input type="number" id="input-${s.id}" style="width:40px" min="0"> 
                    <button class="btn-red" onclick="doCheck(${s.id})">OK</button>
                </td>
            </tr>
        `).join('');

        // æ˜¾ç¤ºåŒºåŸŸè´§å€¼
        if(activeArea) {
            document.getElementById('areaSummaryLine').style.display = 'flex';
            document.getElementById('areaSummaryMoney').innerText = `C$ ${areaVal.toFixed(0)}`;
        } else {
            document.getElementById('areaSummaryLine').style.display = 'none';
        }

        // å†å²è®°å½•è¿‡æ»¤
        const mF = document.getElementById('filterMonth').value, 
              sF = document.getElementById('filterStart').value, 
              eF = document.getElementById('filterEnd').value, 
              qF = document.getElementById('filterSearch').value.toLowerCase();
              
        let filtered = logs.filter(l => {
            if (!l.t) return false;
            const ld = l.t.slice(0,10), lm = l.t.slice(0,7);
            if(mF && lm !== mF) return false;
            if(sF && ld < sF) return false;
            if(eF && ld > eF) return false;
            if(qF && !(l.note || '').toLowerCase().includes(qF)) return false;
            return true;
        });

        let curSale = 0, curBuy = 0;
        document.getElementById('logBody').innerHTML = filtered.slice().reverse().map(l => {
            if(l.type && l.type.includes('é”€å”®')) curSale += l.amt || 0; 
            else if(l.type && l.type.includes('è¿›è´§')) curBuy += l.amt || 0;
            return `<tr>
                <td>${l.t ? l.t.slice(5,16).replace('T',' ') : ''}</td>
                <td>${l.type || ''}: ${l.note || ''}</td>
                <td>${l.q || 0}</td>
                <td style="color:${l.type && l.type.includes('é”€å”®')?'green':'red'}">C$ ${(l.amt || 0).toFixed(1)}</td>
                <td class="admin-only"><button onclick="if(confirm('ç¡®å®šåˆ é™¤? / Â¿Eliminar?')){logs=logs.filter(x=>x.id!==${l.id});save();}">X</button></td>
            </tr>`;
        }).join('');
        
        document.getElementById('logFoot').innerHTML = `<tr style="background:#fff9c4;">
            <td colspan="2">æ±‡æ€»/Resumen:</td>
            <td>é”€å”®/Venta: C$ ${curSale.toFixed(1)}</td>
            <td colspan="2">è¿›è´§/Compra: C$ ${curBuy.toFixed(1)}</td>
        </tr>`;

        // æ‰“å°å†…å®¹
        document.getElementById('printContainer').innerHTML = ['æ€»ä»“åº“/AlmacÃ©n', '1å·å†°ç®±/Nevera 1', '2å·å†°ç®±/Nevera 2', '3å·å†°ç®±/Nevera 3'].map(a => {
            const areaName = a.split('/')[0];
            const list = stocks.filter(x => x.location === areaName).sort((a,b) => (a.cat || '').localeCompare(b.cat || ''));
            return `<div class="print-area-title">${a}</div>
                <table>
                    <thead><tr><th>åˆ†ç±»/Cat</th><th>äº§å“/Prod</th><th>åº“å­˜/Sist</th><th>å®æµ‹/Real</th></tr></thead>
                    <tbody>${list.map(s => `<tr><td>${s.cat || ''}</td><td>${s.name || ''} (${s.spec || ''})</td><td>${s.qty || 0}</td><td>____</td></tr>`).join('')}</tbody>
                </table>`;
        }).join('');
    }

    // ==================== åˆå§‹åŒ– ====================
    window.onload = () => {
        updateAdminMode();
        render();
        initFirebase();
        
        // æ¯5åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡
        autoSyncInterval = setInterval(() => {
            if (firebaseLoaded && !syncInProgress) {
                saveToCloud();
            }
        }, 5 * 60 * 1000);
    };
</script>
</body>
</html>
